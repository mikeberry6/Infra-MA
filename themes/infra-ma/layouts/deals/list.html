{{ define "main" }}

{{/* Cinematic Header */}}
<section class="page-hero">
  <div class="container">
    <p class="page-hero-eyebrow">Deal Database</p>
    <h1 class="page-hero-title">All <span class="page-hero-title-accent">Deals</span></h1>
    <p class="page-hero-subtitle">Browse and filter sponsor-backed infrastructure transactions</p>
    <div class="page-hero-divider"></div>
  </div>
</section>

<section class="section">
  <div class="container">

    {{/* View Toggle */}}
    <div class="view-toggle" id="view-toggle">
      <button class="view-toggle-btn is-active" data-view="grid">Grid</button>
      <button class="view-toggle-btn" data-view="timeline">Timeline</button>
    </div>

    {{/* Filter Bar */}}
    <div class="filter-bar">
      <div class="filter-bar-inner">
        <input type="text" id="deal-search" class="filter-input" placeholder="Search deals...">
        <div class="filter-controls">
          <select id="filter-sector" class="filter-select">
            <option value="">All Sectors</option>
            {{ range $name, $sector := .Site.Data.sectors }}
            <option value="{{ $name }}">{{ $name }}</option>
            {{ end }}
          </select>
          <select id="filter-subsector" class="filter-select">
            <option value="">All Subsectors</option>
            {{ range $name, $sector := .Site.Data.sectors }}
              {{ range $sector.subsectors }}
              <option value="{{ . }}">{{ . }}</option>
              {{ end }}
            {{ end }}
          </select>
          <select id="filter-geography" class="filter-select">
            <option value="">All Geographies</option>
            {{ $geos := slice }}
            {{ range (where .Site.RegularPages "Section" "deals") }}
              {{ with .Params.geography }}
                {{ if not (in $geos .) }}
                  {{ $geos = $geos | append . }}
                {{ end }}
              {{ end }}
            {{ end }}
            {{ range sort $geos }}
            <option value="{{ . }}">{{ . }}</option>
            {{ end }}
          </select>
          <select id="filter-fund" class="filter-select">
            <option value="">All Funds</option>
            {{ range .Site.Data.funds }}
            <option value="{{ . }}">{{ . }}</option>
            {{ end }}
          </select>
          <select id="filter-status" class="filter-select">
            <option value="">All Statuses</option>
            <option value="Announced">Announced</option>
            <option value="Closed">Closed</option>
            <option value="Terminated">Terminated</option>
          </select>
          <button id="filter-reset" class="filter-reset">Reset</button>
        </div>
      </div>
      <div class="filter-bar-inner">
        <div id="active-filters" class="active-filters"></div>
      </div>
    </div>

    <p id="results-count" class="results-count">{{ len .Pages }} deals</p>

    {{ $deals := .Pages.ByDate.Reverse }}
    {{ if $deals }}

    {{/* Grid View */}}
    <div id="deals-list" class="deal-grid">
      {{ range $deals }}
      {{ $sc := "#555" }}
      {{ with $.Site.Data.sectors }}{{ $s := index . ($.Params.sector | default "") }}{{ with $s }}{{ $sc = .color }}{{ end }}{{ end }}
      <div class="deal-card-wrapper"
           data-sector="{{ .Params.sector | default "" }}"
           data-subsector="{{ .Params.subsector | default "" }}"
           data-geography="{{ .Params.geography | default "" }}"
           data-fund="{{ .Params.buyer | default "" }}"
           data-status="{{ .Params.status | default "" }}"
           data-value="{{ .Params.value | default "" }}"
           data-date="{{ .Date.Format "2006-01-02" }}"
           data-title="{{ .Title }}"
           data-url="{{ .RelPermalink }}"
           data-color="{{ $sc }}"
           data-search="{{ .Title | lower }} {{ .Params.buyer | default "" | lower }} {{ .Params.seller | default "" | lower }} {{ .Params.target | default "" | lower }} {{ .Params.geography | default "" | lower }}">
        {{ partial "deal-card.html" . }}
      </div>
      {{ end }}
    </div>

    {{/* Timeline View (hidden by default, populated by JS) */}}
    <div id="deals-timeline" class="timeline-container" style="display: none;">
      <div class="timeline" id="timeline"></div>
    </div>

    {{ else }}
    <div class="empty-state">
      <div class="empty-state-icon">&#x1F50D;</div>
      <h3 class="empty-state-title">No deals yet</h3>
      <p>Check back after the next weekly update for new infrastructure M&amp;A activity.</p>
    </div>
    {{ end }}
  </div>
</section>
{{ end }}
