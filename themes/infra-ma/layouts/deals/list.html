{{ define "main" }}
{{ $deals := (where .Site.RegularPages "Section" "deals").ByDate.Reverse }}
{{ $totalDeals := len $deals }}
{{ $totalValue := 0.0 }}
{{ $closedCount := 0 }}
{{ $announcedCount := 0 }}
{{ $terminatedCount := 0 }}
{{ range $deals }}
  {{ with .Params.value_usd_billions }}{{ $totalValue = add $totalValue . }}{{ end }}
  {{ if eq .Params.status "closed" }}{{ $closedCount = add $closedCount 1 }}{{ end }}
  {{ if eq .Params.status "announced" }}{{ $announcedCount = add $announcedCount 1 }}{{ end }}
  {{ if eq .Params.status "terminated" }}{{ $terminatedCount = add $terminatedCount 1 }}{{ end }}
{{ end }}

<div class="tracker">

  {{/* Header */}}
  <header class="tracker__header">
    <h1 class="tracker__title">Deal Tracker</h1>
    <p class="tracker__subtitle mono">{{ $totalDeals }} transactions &middot; ${{ lang.FormatNumberCustom 0 $totalValue }}B total value</p>
  </header>

  {{/* Bento KPIs */}}
  <div class="bento">
    <div class="bento__card">
      <span class="bento__label">Total Deals</span>
      <span class="bento__value mono">{{ $totalDeals }}</span>
    </div>
    <div class="bento__card">
      <span class="bento__label">Total Value</span>
      <span class="bento__value mono">${{ lang.FormatNumberCustom 0 $totalValue }}B</span>
    </div>
    <div class="bento__card">
      <span class="bento__label">Avg Size</span>
      <span class="bento__value mono">${{ lang.FormatNumberCustom 1 (div $totalValue (float $totalDeals)) }}B</span>
    </div>
    <div class="bento__card">
      <span class="bento__label">Announced</span>
      <span class="bento__value mono"><span class="dot dot--announced"></span>{{ $announcedCount }}</span>
    </div>
    <div class="bento__card">
      <span class="bento__label">Closed</span>
      <span class="bento__value mono"><span class="dot dot--closed"></span>{{ $closedCount }}</span>
    </div>
    <div class="bento__card">
      <span class="bento__label">Terminated</span>
      <span class="bento__value mono"><span class="dot dot--terminated"></span>{{ $terminatedCount }}</span>
    </div>
  </div>

  {{/* Filters */}}
  <div class="filters" id="filters">
    <div class="filters__group">
      <span class="filters__label">Status</span>
      <button class="fpill fpill--active" data-filter="status" data-value="all">All</button>
      <button class="fpill" data-filter="status" data-value="announced">Announced</button>
      <button class="fpill" data-filter="status" data-value="closed">Closed</button>
      <button class="fpill" data-filter="status" data-value="terminated">Terminated</button>
    </div>
    <div class="filters__group">
      <span class="filters__label">Sector</span>
      <button class="fpill fpill--active" data-filter="sector" data-value="all">All</button>
      <button class="fpill" data-filter="sector" data-value="energy">Energy</button>
      <button class="fpill" data-filter="sector" data-value="transport">Transport</button>
      <button class="fpill" data-filter="sector" data-value="digital">Digital</button>
      <button class="fpill" data-filter="sector" data-value="water">Water</button>
      <button class="fpill" data-filter="sector" data-value="social">Social</button>
    </div>
    <div class="filters__group">
      <span class="filters__label">Sort</span>
      <button class="fpill fpill--active" data-sort="date">Newest</button>
      <button class="fpill" data-sort="value">Largest</button>
      <button class="fpill" data-sort="alpha">A–Z</button>
    </div>
  </div>

  {{/* Table */}}
  <div class="table-wrap">
    <table class="table" id="deals-table">
      <thead>
        <tr>
          <th class="th--status">Status</th>
          <th class="th--deal">Deal</th>
          <th class="th--buyer">Buyer</th>
          <th class="th--seller">Seller</th>
          <th class="th--value">Value</th>
          <th class="th--sector">Sector</th>
          <th class="th--geo">Geography</th>
          <th class="th--date">Date</th>
          <th class="th--source">Source</th>
        </tr>
      </thead>
      <tbody id="deals-tbody">
        {{ range $deals }}
        {{ $status := .Params.status | default "announced" }}
        {{ $publisher := "" }}
        {{ with .Params.source_url }}
          {{ $publisher = replaceRE `^https?://(www\.)?` "" . }}
          {{ $publisher = replaceRE `/.*` "" $publisher }}
        {{ end }}
        <tr class="row"
            data-status="{{ $status }}"
            data-sector="{{ .Params.sector | default "" }}"
            data-value="{{ .Params.value_usd_billions | default 0 }}"
            data-date="{{ .Date.Format "2006-01-02" }}"
            data-title="{{ .Title }}"
            data-href="{{ .RelPermalink }}"
            data-buyer="{{ .Params.buyer | default "" }}"
            data-seller="{{ .Params.seller | default "" }}"
            data-deal-value="{{ .Params.deal_value | default "" }}"
            data-geography="{{ .Params.geography | default "" }}"
            data-asset="{{ .Params.asset | default "" }}"
            data-summary="{{ .Params.summary | default "" }}"
            data-source="{{ .Params.source_url | default "" }}">
          <td class="td--status"><span class="dot dot--{{ $status }}"></span><span class="status-text">{{ $status }}</span></td>
          <td class="td--deal"><a href="{{ .RelPermalink }}" class="deal-link">{{ .Title }}</a></td>
          <td class="td--buyer">{{ .Params.buyer | default "—" }}</td>
          <td class="td--seller">{{ .Params.seller | default "—" }}</td>
          <td class="td--value mono">{{ .Params.deal_value | default "—" }}</td>
          <td class="td--sector">{{ with .Params.sector }}<span class="pill pill--{{ urlize . }}">{{ . }}</span>{{ end }}</td>
          <td class="td--geo">{{ .Params.geography | default "—" }}</td>
          <td class="td--date mono">{{ .Date.Format "Jan 2, 2006" }}</td>
          <td class="td--source">{{ if $publisher }}<a href="{{ .Params.source_url }}" target="_blank" rel="noopener" class="source-link">{{ $publisher }} <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>{{ else }}—{{ end }}</td>
        </tr>
        {{ end }}
      </tbody>
    </table>
  </div>

  {{/* Results count */}}
  <div class="tracker__footer">
    <span class="tracker__count mono" id="results-count">{{ $totalDeals }} deals</span>
  </div>
</div>

{{/* Peek Drawer */}}
<div class="peek-overlay" id="peek-overlay"></div>
<aside class="peek" id="peek" aria-hidden="true">
  <div class="peek__header">
    <button class="peek__close" id="peek-close" aria-label="Close">&times;</button>
  </div>
  <div class="peek__content">
    <div class="peek__status" id="peek-status"></div>
    <h2 class="peek__title" id="peek-title"></h2>
    <p class="peek__value mono" id="peek-value"></p>
    <div class="peek__section">
      <h3 class="peek__label">Parties</h3>
      <p id="peek-buyer"></p>
      <p id="peek-seller"></p>
    </div>
    <div class="peek__section">
      <h3 class="peek__label">Details</h3>
      <dl class="peek__facts" id="peek-facts"></dl>
    </div>
    <div class="peek__section">
      <h3 class="peek__label">Summary</h3>
      <p id="peek-summary"></p>
    </div>
    <div class="peek__actions">
      <a href="#" class="peek__btn" id="peek-detail">View Full Detail →</a>
      <a href="#" class="peek__btn peek__btn--ext" id="peek-source" target="_blank" rel="noopener">View Source ↗</a>
    </div>
  </div>
</aside>

{{ end }}
