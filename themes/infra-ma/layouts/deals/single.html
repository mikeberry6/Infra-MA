{{ define "main" }}
{{ $status := .Params.status | default "announced" }}
<article class="deal">

  <a href="{{ "deals/" | relURL }}" class="deal__back">← Back to Tracker</a>

  <header class="deal__header">
    <div class="deal__badges">
      <span class="status status--{{ $status }}">{{ $status }}</span>
      {{ with .Params.sector }}<span class="pill pill--{{ urlize . }}">{{ . }}</span>{{ end }}
    </div>
    <h1 class="deal__title">{{ .Title }}</h1>
    <p class="deal__sub">
      {{ with .Params.buyer }}{{ . }}{{ end }}
      {{ if and .Params.buyer .Params.asset }} → {{ end }}
      {{ with .Params.asset }}{{ . }}{{ end }}
    </p>
    <div class="deal__header-meta">
      <time class="mono" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
      {{ with .Params.geography }}<span>{{ . }}</span>{{ end }}
      {{ with .Params.deal_value }}<span class="mono deal__header-value">{{ . }}</span>{{ end }}
    </div>
  </header>

  <div class="deal__grid">
    <div class="deal__main">

      {{/* Parties */}}
      <section class="deal__section">
        <h2 class="deal__heading">Parties</h2>
        <div class="deal__parties">
          {{ if .Params.buyer }}
          <div class="party">
            <span class="party__role">Buyer</span>
            <h3 class="party__name">{{ .Params.buyer }}</h3>
            {{ with .Params.buyer_description }}<p class="party__desc">{{ . }}</p>{{ end }}
          </div>
          {{ end }}
          {{ if .Params.seller }}
          <div class="party">
            <span class="party__role">Seller</span>
            <h3 class="party__name">{{ .Params.seller }}</h3>
            {{ with .Params.seller_description }}<p class="party__desc">{{ . }}</p>{{ end }}
          </div>
          {{ end }}
        </div>
      </section>

      {{/* Asset */}}
      {{ if or .Params.asset .Params.asset_description }}
      <section class="deal__section">
        <h2 class="deal__heading">Asset</h2>
        <h3 class="party__name">{{ .Params.asset | default "TBD" }}</h3>
        {{ with .Params.asset_description }}<p class="party__desc">{{ . }}</p>{{ end }}
      </section>
      {{ end }}

      {{/* Content */}}
      {{ if .Content }}
      <section class="deal__section">
        <h2 class="deal__heading">Overview</h2>
        <div class="deal__content">{{ .Content }}</div>
      </section>
      {{ end }}
    </div>

    {{/* Sidebar */}}
    <aside class="deal__sidebar">
      <div class="deal__facts-card">
        <h2 class="deal__facts-heading">Quick Facts</h2>
        <dl class="deal__facts">
          {{ with .Params.deal_value }}
          <div class="fact"><dt>Value</dt><dd class="mono">{{ . }}</dd></div>
          {{ end }}
          <div class="fact"><dt>Status</dt><dd><span class="dot dot--{{ $status }}"></span> {{ $status }}</dd></div>
          {{ with .Params.sector }}
          <div class="fact"><dt>Sector</dt><dd><span class="pill pill--{{ urlize . }}">{{ . }}</span></dd></div>
          {{ end }}
          {{ with .Params.geography }}
          <div class="fact"><dt>Geography</dt><dd>{{ . }}</dd></div>
          {{ end }}
          <div class="fact"><dt>Date</dt><dd class="mono">{{ .Date.Format "Jan 2, 2006" }}</dd></div>
          {{ with .Params.source_url }}
          <div class="fact"><dt>Source</dt><dd><a href="{{ . }}" target="_blank" rel="noopener">View ↗</a></dd></div>
          {{ end }}
        </dl>
      </div>

      {{/* Related */}}
      {{ $currentSector := .Params.sector }}
      {{ $currentPage := . }}
      {{ $related := slice }}
      {{ range (where (where $.Site.RegularPages "Section" "deals") ".Params.sector" $currentSector) }}
        {{ if ne .Permalink $currentPage.Permalink }}
          {{ $related = $related | append . }}
        {{ end }}
      {{ end }}
      {{ if $related }}
      <div class="deal__facts-card">
        <h2 class="deal__facts-heading">Related Deals</h2>
        {{ range first 4 $related }}
        <a href="{{ .RelPermalink }}" class="related">
          <span class="related__title">{{ .Title }}</span>
          <span class="related__meta mono">{{ with .Params.deal_value }}{{ . }} · {{ end }}{{ .Date.Format "Jan 2006" }}</span>
        </a>
        {{ end }}
      </div>
      {{ end }}
    </aside>
  </div>
</article>
{{ end }}
