{{ define "main" }}
{{ $deals := where .Site.RegularPages "Section" "deals" }}
{{ $totalDeals := len $deals }}
{{ $totalValue := 0.0 }}
{{ $closedCount := 0 }}
{{ $announcedCount := 0 }}
{{ $terminatedCount := 0 }}
{{ $recentDeals := (where .Site.RegularPages "Section" "deals").ByDate.Reverse }}
{{ range $deals }}
  {{ with .Params.value_usd_billions }}{{ $totalValue = add $totalValue . }}{{ end }}
  {{ if eq .Params.status "closed" }}{{ $closedCount = add $closedCount 1 }}{{ end }}
  {{ if eq .Params.status "announced" }}{{ $announcedCount = add $announcedCount 1 }}{{ end }}
  {{ if eq .Params.status "terminated" }}{{ $terminatedCount = add $terminatedCount 1 }}{{ end }}
{{ end }}

{{/* Ticker */}}
<div class="ticker" aria-hidden="true">
  <div class="ticker__track">
    {{ range first 20 $recentDeals }}
    <span class="ticker__item">
      <span class="ticker__dot ticker__dot--{{ .Params.status | default "announced" }}"></span>
      {{ .Title }}
      {{ with .Params.deal_value }}<span class="ticker__val">{{ . }}</span>{{ end }}
    </span>
    {{ end }}
    {{ range first 20 $recentDeals }}
    <span class="ticker__item">
      <span class="ticker__dot ticker__dot--{{ .Params.status | default "announced" }}"></span>
      {{ .Title }}
      {{ with .Params.deal_value }}<span class="ticker__val">{{ . }}</span>{{ end }}
    </span>
    {{ end }}
  </div>
</div>

<div class="briefing">

  {{/* Header */}}
  <header class="briefing__header">
    <h1 class="briefing__date">{{ now.Format "Monday, January 2" }}.</h1>
    <p class="briefing__summary">
      <span class="mono">{{ $announcedCount }}</span> announced &middot;
      <span class="mono">{{ $closedCount }}</span> closed &middot;
      <span class="mono">{{ $totalDeals }}</span> tracked
    </p>
  </header>

  {{/* KPI Strip */}}
  <div class="kpi">
    <div class="kpi__card">
      <span class="kpi__value">{{ $totalDeals }}</span>
      <span class="kpi__label">Total Deals</span>
    </div>
    <div class="kpi__card">
      <span class="kpi__value">${{ lang.FormatNumberCustom 0 $totalValue }}B</span>
      <span class="kpi__label">Aggregate Value</span>
    </div>
    <div class="kpi__card">
      <span class="kpi__value">${{ lang.FormatNumberCustom 1 (div $totalValue (float $totalDeals)) }}B</span>
      <span class="kpi__label">Avg Deal Size</span>
    </div>
    <div class="kpi__card">
      <div class="kpi__badges">
        <span class="badge badge--announced">{{ $announcedCount }}</span>
        <span class="badge badge--closed">{{ $closedCount }}</span>
        <span class="badge badge--terminated">{{ $terminatedCount }}</span>
      </div>
      <span class="kpi__label">Pipeline</span>
    </div>
  </div>

  {{/* Search */}}
  <div class="briefing__search">
    <div id="search"></div>
  </div>

  {{/* Timeline */}}
  <section class="timeline">
    <div class="section-header">
      <h2 class="section-title">Recent Activity</h2>
      <a href="{{ "deals/" | relURL }}" class="section-link">View all →</a>
    </div>
    <div class="timeline__feed">
      {{ range first 15 $recentDeals }}
      {{ $status := .Params.status | default "announced" }}
      <article class="tl-card" data-href="{{ .RelPermalink }}">
        <div class="tl-card__rail">
          <span class="tl-card__dot tl-card__dot--{{ $status }}"></span>
          <span class="tl-card__line"></span>
        </div>
        <div class="tl-card__body">
          <time class="tl-card__time" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
          <h3 class="tl-card__title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
            {{ with .Params.deal_value }}<span class="tl-card__val">{{ . }}</span>{{ end }}
          </h3>
          <p class="tl-card__parties">
            {{ with .Params.buyer }}{{ . }}{{ end }}{{ if and .Params.buyer .Params.seller }} → {{ end }}{{ with .Params.seller }}{{ . }}{{ end }}
          </p>
          <div class="tl-card__meta">
            {{ with .Params.sector }}
            <span class="pill pill--{{ urlize . }}">{{ . }}</span>
            {{ end }}
            {{ with .Params.geography }}
            <span class="tl-card__geo">{{ . }}</span>
            {{ end }}
            <span class="status status--{{ $status }}">{{ $status }}</span>
          </div>
        </div>
      </article>
      {{ end }}
    </div>
  </section>

  {{/* Sectors */}}
  <section class="sectors">
    <div class="section-header">
      <h2 class="section-title">Sectors</h2>
    </div>
    <div class="sectors__grid">
      {{ $sectorNames := dict "energy" "Energy" "transport" "Transport" "digital" "Digital" "water" "Water" "social" "Social" }}
      {{ range $key, $name := $sectorNames }}
      {{ $count := 0 }}
      {{ $val := 0.0 }}
      {{ range (where $.Site.RegularPages "Section" "deals") }}
        {{ if eq .Params.sector $key }}
          {{ $count = add $count 1 }}
          {{ with .Params.value_usd_billions }}{{ $val = add $val . }}{{ end }}
        {{ end }}
      {{ end }}
      <div class="sector-card">
        <span class="sector-card__dot sector-card__dot--{{ $key }}"></span>
        <span class="sector-card__name">{{ $name }}</span>
        <span class="sector-card__count mono">{{ $count }}</span>
        <span class="sector-card__val mono">${{ lang.FormatNumberCustom 1 $val }}B</span>
      </div>
      {{ end }}
    </div>
  </section>

</div>
{{ end }}
